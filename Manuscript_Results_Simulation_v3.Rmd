---
title: "Manuscript Results Simulation"
author: "Luis Zapata"
output:
  pdf_document: default
  html_document:
    theme: paper
    df_print: paged
    #highlight: tango
---

#Results: Evolutionary dynamics of dN/dS under neutral evolution

Points to cover:
1. dN/dS values undere neutrality fluctuate around 1, the variance is dependent on the number of mutations
so you can have global dnds values of 2 or 0.5 and still are neutral.

2. under neutral dynamics cells never grow exponentially and saturation the system

3. Approximate half of them go extinct based on random fluctuations when starting with a population of 32 stem cells
s

4. Even in neutral evolving populations mutations accumulate

5. The co

To understand the dynamics of dN/dS values over time we first simulated a branching process with only neutral mutations (non-synonymous passenger and synonymous mutations) (Fig 2) in a initial population of 32 stem cells. We classified each simulations into three scenarios based on their outcome at the last simulated step: ongoing, extinction and saturation, which are equivalent to an homeostatic, a regressing and an emergent tumor population, respectively. As described previously (X) and expected by equation X, the neutral dynamics produced an homeostatic  population of 32 cells over time accross 100 simulations (Fig 2A).

The total mutation burden in populations that are going extinct is limited by the low number of cells present before dissapearing while non-extincted populations kept accumulating somatic mutations at every cell division (Fig 2B). Expectedly, we observed that dN/dS values fluctuate around 1 under neutral dynamics. However, the variance was consitently large along the generations (Fig 2C, 95%CI=0.54-2.31).

To address the effect of mutation rate on dN/dS under neutral dynamics we compared MSS tumors (u=10-8), MSI (u=10-7), and POLE (u=10-6) (Supplementary Material X). In the last generation, non-extinct populations harbored between 10^2 - 10^3  mutations in MSS, 10^2 - 10^4 in MSI, and 10^3 - 10^5 in POLE tumors. We observed that at high mutation rates, such as in MSI or POLE tumors, the variance of dN/dS was smaller compared to MSS tumors (95%CI for MSS: 0.54-2.31, MSI:0.79-1.30, POLE:0.91-1.06), suggesting that dN/dS values should be taken cautiously when inferring selection using low number of mutations. In addition, none of the simulations reached the carrying capacity (2000 cells) in any of the three mutation rate scenarios. The number of stable populations was approximately equal to the number of extinct populations for MSS, MSI and POLE tumors (Fig 3A). The median time for extinction was between 37 (low mutation rate) and 32 (high mutation rate) generations (Fig 3B) with a very widespread distribution along the number of generations. 

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, #fig.path='"~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations/Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r source parameters,message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
###plotting for paper
library(ggsci)
library(ggrepel)
library(tidyverse)
library("scales")
library(ggpubr)
library(RColorBrewer)
rm(list = ls())
source("functions_ZCsimulator.R")
source("simulator.R")
```

```{r, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
load(file = "~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_neutral.RData")

fulltimeseries1 = stats_dnds(RUNS)
fulltimeevo1 = evodevo(RUNS, 8, 500)

load(file = "~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSI_neutral.RData")

fulltimeseries2 = stats_dnds(RUNS)
fulltimeevo2 = evodevo(RUNS, 8, 500)

#plot_threeV2(fulltimeseries2, maxt = 50,  maintitle ="2 Neutral MSI")

load(file = "~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/POLE_neutral.RData")

fulltimeseries3 = stats_dnds(RUNS)
fulltimeevo3 = evodevo(RUNS, 8, 500)

#plot_threeV2(fulltimeseries3,maxt= 50, maintitle = "2 Neutral POLE" )

fulltimeseries1$class<-"MSS"
fulltimeseries2$class<-"MSI"
fulltimeseries3$class<-"POLE"

fulltimeevo1$class<-"MSS"
fulltimeevo2$class<-"MSI"
fulltimeevo3$class<-"POLE"

fulltime_neutral<-rbind(fulltimeseries1,fulltimeseries2,fulltimeseries3)
fulltime_neutral$class <- factor(fulltime_neutral$class, levels = c("MSS","MSI","POLE"))

fulltimeevo_neutral<-rbind(fulltimeevo1,fulltimeevo2,fulltimeevo3)
fulltimeevo_neutral$class <- factor(fulltimeevo_neutral$class, levels = c("MSS","MSI","POLE"))

pptneu<-plot_metric_class(fulltime_neutral, maxt = 50, maintitle = "2A. Neutral dynamics")
plot_metric_classevo(fulltimeevo_neutral, maxt = 50, maintitle = "2B. Neutral dynamics. N0 32 cells")


#ggsave(filename = "~/Desktop/neutral_population.pdf", pptneu, width = 30, height = 15, units = "cm")



```

#Results: Evolutionary dynamics of dN/dS under positive selection

Points to cover:
5. Once you include driver mutations you always lose the balance (ongoing populations), they either die (extinction) or saturation the system

7. If  a driver mutation appear in a background of 0 silent mutation, the respective dN/dS will be infinite until any of the cells in that population start to accumulate synonymous mutations

8. In the moment that synonymous mutations are expanding within the population carrying the driver, the dn/ds of the driver starts to converge towards 1

9. Overall selection (global dN/dS) in the presence/absence of drivers will converge towards one invariably because there is much more neutral genome to hit (all the nonsynomymous passengers.

Next, we explored how driver mutations in tumors shape the observed counts of cells, mutations, and dN/dS values. The model shows that when the probability of hitting a driver is high (10^-2) almost all populations (ongoing) dissapear or go extinct in 100 generations (fig X). 

We also show that at the early stages of somatic cell growth with a driver, multiple drivers can lead to independent clonal expansions. If the availability of driver positions in the genome remains constant (infinite sites model), the amount of emerging subclones is a function of the clone size and the probability of hitting a driver mutation. Even if we set that the mean number of driver events that would increase fitness in a cancer is on average 5, if a tumor is large enough it will constantly acquire new drivers that by definition would not be longer a driver event given those drivers do not have the capacity to increase the fitness further. Thus, the probability of hitting a driver for that clone should decrease every time a new driver has been touched.


##Drivers during tumor evolution

```{r, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_D_01.RData")
fulltimeseries_d1 = stats_dnds(RUNS)
fulltimeevo_d1 = evodevo(RUNS, 8, 500)
fulltimeevo_d1$class<-"D:0.01"
M1<-RUNS[[4]]

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_D_005.RData")
fulltimeseries_d2 = stats_dnds(RUNS)
fulltimeevo_d2 = evodevo(RUNS, 8, 500)
fulltimeevo_d2$class<-"D:0.005"
M2<-RUNS[[8]]

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_D_001.RData")
fulltimeseries_d3 = stats_dnds(RUNS)
fulltimeevo_d3 = evodevo(RUNS, 8, 500)
fulltimeevo_d3$class<-"D:0.001"
M3<-RUNS[[8]]

fulltime_driver<-rbind(fulltimeevo_d1,fulltimeevo_d2,fulltimeevo_d3)

####Plotting ggmuller
plot_M1<-mullerplot(M1,add_clone_tree = F)
plot_M2<-mullerplot(M2,add_clone_tree = F)
plot_M3<-mullerplot(M3,add_clone_tree = F)

ggarrange(plot_M1,plot_M2,plot_M3,nrow = 3)

#plotting simulations
plot_threeV4(fulltimeseries_d1, maintitle = "Only Driver 0.01")
plot_threeV4(fulltimeseries_d2, maintitle = "Only Driver 0.005")
plot_threeV4(fulltimeseries_d3, maintitle = "Only Driver 0.001")

#Plotting summary of simulations
plot_metric_classevo(fulltime_driver, maintitle = "Only Drivers")

```

#Drivers and immune system

```{r, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_00_driver_01_IM_05.RData")
fulltimeseries_i0 = stats_dnds(RUNS)
fulltimeevo_i0 = evodevo(RUNS, 8, 500)
fulltimeevo_i0$class = "I:0"
#plot_threeV4(fulltimeseries, maintitle = "Driver .01 / Immunogenic .05 / No Immune attack")
#plot_threeV3(fulltimeevo, maintitle = "Driver .01 / Immunogenic .05 / No Immune attack")
#M<-RUNS[[4]]
#mullerplot(M,add_clone_tree = F)

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_05_driver_01_IM_05.RData")
fulltimeseries_i1 = stats_dnds(RUNS)
fulltimeevo_i1 = evodevo(RUNS, 8, 500)
fulltimeevo_i1$class = "I:0.05"


load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_25_driver_01_IM_05.RData")
fulltimeseries_i2 = stats_dnds(RUNS)
fulltimeevo_i2 = evodevo(RUNS, 8, 500)
fulltimeevo_i2$class = "I:0.25"

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_50_driver_01_IM_05.RData")
fulltimeseries_i3 = stats_dnds(RUNS)
fulltimeevo_i3 = evodevo(RUNS, 8, 500)
fulltimeevo_i3$class = "I:0.50"

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_75_driver_01_IM_05.RData")
fulltimeseries_i4 = stats_dnds(RUNS)
fulltimeevo_i4 = evodevo(RUNS, 8, 500)
fulltimeevo_i4$class = "I:0.75"

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_90_driver_01_IM_05.RData")
fulltimeseries_i5 = stats_dnds(RUNS)
fulltimeevo_i5 = evodevo(RUNS, 8, 500)
fulltimeevo_i5$class = "I:0.90"

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_01_IM_05.RData")
fulltimeseries_i6 = stats_dnds(RUNS)
fulltimeevo_i6 = evodevo(RUNS, 8, 500)
fulltimeevo_i6$class = "I:0.99"


fulltimeevo_immuno <- rbind(fulltimeevo_i0,fulltimeevo_i1,fulltimeevo_i2,fulltimeevo_i3,fulltimeevo_i4,fulltimeevo_i5,fulltimeevo_i6)
fulltimeevo_immuno = fulltimeevo_immuno %>% mutate(class2 = ifelse(class %in% c("I:0.99","I:0.95","I:0.90","I:0.75") , "HIGH", ifelse(class %in% c("I:0.25","I:0.10","I:0.05","I:0.01"), "LOW", "MID") ) )

fulltimeevo_immuno$class2 <- factor(fulltimeevo_immuno$class2, levels = c("LOW","MID","HIGH"))

plot_metric_classevo(fulltimeevo_immuno)

plot_statistic_clasevo1(fulltimeevo_immuno)

plot_statistic_clasevo2(fulltimeevo_immuno)

ggstatsplot::grouped_ggbetweenstats(data = fulltimeevo_immuno %>% filter(event != "Ongoing"), 
                                    x = class,
                                    y = time,
                                    grouping.var =  event,
                                    type = "np",
                                    pairwise.comparisons = T
                                    )


ggstatsplot::grouped_ggbetweenstats(data = fulltimeevo_immuno%>% filter(event != "Ongoing",!is.infinite(fin_dndsi)),
                            x = class, 
                            y = fin_dnds,plot.type = "violin", type = "np", bf.message = F, notch = T, linetype = "dashed", outlier.shape = NA,messages = F,p.adjust.method = "BH",mean.plotting = T,mean.size = 4,grouping.var = event)
ggstatsplot::grouped_ggbetweenstats(data = fulltimeevo_immuno%>% filter(event != "Ongoing",!is.infinite(fin_dndsi)),
                            x = class, 
                            y = fin_dndsd, plot.type = "violin", type = "np", bf.message = F, notch = T, linetype = "dashed", outlier.shape = NA,messages = F,p.adjust.method = "BH",mean.plotting = T,mean.size = 4,grouping.var = event)
ggstatsplot::grouped_ggbetweenstats(data = fulltimeevo_immuno%>% filter(event != "Ongoing",!is.infinite(fin_dndsi)),
                            x = class, 
                            y = fin_dndsi, plot.type = "violin", type = "np", bf.message = F, notch = T, linetype = "dashed", outlier.shape = NA,messages = F,p.adjust.method = "BH",mean.plotting = T,mean.size = 4,grouping.var = event
                              )

ggscatter(fulltimeevo_immuno %>% filter(event=="Collapse"),x = "fin_dnds", y = "time") 
```


```{r, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_01_IM_05_E_0001.RData")
fulltimeseries_e1 = stats_dnds(RUNS)
fulltimeevo_e1 = evodevo(RUNS, 8, 500)
fulltimeevo_e1$class = "E:0.0001"

# plot_threeV4(fulltimeseries, maintitle = "Driver .01 / Immunogenic .05 / 99% Immune attack / Escape .01")
# plot_threeV3(fulltimeevo, maintitle = "Driver .01 / Immunogenic .05 / 99% Immune attack / Escape .01")
# 
# M<-RUNS[[4]]
# mullerplot(M,add_clone_tree = F)

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_01_IM_05_E_001.RData")
fulltimeseries_e2 = stats_dnds(RUNS)
fulltimeevo_e2 = evodevo(RUNS, 8, 500)
fulltimeevo_e2$class = "E:0.001"

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_01_IM_05_E_005.RData")
fulltimeseries_e3 = stats_dnds(RUNS)
fulltimeevo_e3 = evodevo(RUNS, 8, 500)
fulltimeevo_e3$class = "E:0.005"

load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_01_IM_05_E_01.RData")
fulltimeseries_e4 = stats_dnds(RUNS)
fulltimeevo_e4 = evodevo(RUNS, 8, 500)
fulltimeevo_e4$class = "E:0.01"


#load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_01_IM_05_E_05.RData")
#fulltimeseries_e5 = stats_dnds(RUNS)
#fulltimeevo_e5 = evodevo(RUNS, 8, 500)
#fulltimeevo_e5$class = "E:0.05"


fulltimeevo_escape1 <- rbind(fulltimeevo_e1,fulltimeevo_e2,fulltimeevo_e3,fulltimeevo_e4)
fulltimeevo_escape1$class2<-fulltimeevo_escape1$class
plot_metric_classevo(fulltimeevo_escape1)
plot_statistic_clasevo1(fulltimeevo_escape1)
# plot_threeV4(fulltimeseries, maintitle = "Driver .01 / Immunogenic .05 / 99% Immune attack / Escape .05")
# plot_threeV3(fulltimeevo, maintitle = "Driver .01 / Immunogenic .05 / 99% Immune attack / Escape .05")
# 
# M<-RUNS[[4]]
# mullerplot(M,add_clone_tree = F)
#dnds_plot(M)
#plot_clone_dnds(M)
```


```{r, message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_001_IM_02_E_01.RData")
fulltimeseries_e4 = stats_dnds(RUNS)
fulltimeevo_e4 = evodevo(RUNS, 8, 500)
fulltimeevo_e4$class = "D:0.001;E:0.01;I:0.02"
# plot_threeV4(fulltimeseries, maintitle = "Driver .001 / Immunogenic .02 / 99% Immune attack / Escape .01")
# plot_threeV3(fulltimeevo, maintitle = "Driver .001 / Immunogenic .02 / 99% Immune attack / Escape .01")
# 
# M<-RUNS[[7]]
# mullerplot(M,add_clone_tree = F)
#dnds_plot(M)
#plot_clone_dnds(M)
                
load(file="~/Dropbox (Personal)/Postdoc/Projects/simul_dnds/simulations3/MSS_IA_99_driver_001_IM_02_E_05.RData")
fulltimeseries_e5 = stats_dnds(RUNS)
fulltimeevo_e5 = evodevo(RUNS, 8, 500)
fulltimeevo_e5$class = "D:0.001;E:0.05;I:0.02"

fulltimeevo_escape3 <-rbind(fulltimeevo_e4,fulltimeevo_e5)
fulltimeevo_escape3$class2<-fulltimeevo_escape3$class
plot_metric_classevo(fulltimeevo_escape3)
plot_statistic_clasevo1(fulltimeevo_escape3)
# plot_threeV4(fulltimeseries, maintitle = "Driver .001 / Immunogenic .02 / 99% Immune attack / Escape .05")
# plot_threeV3(fulltimeevo, maintitle = "Driver .001 / Immunogenic .02 / 99% Immune attack / Escape .05")
# 
# M<-RUNS[[4]]
# mullerplot(M,add_clone_tree = F)
#dnds_plot(M)
#plot_clone_dnds(M)
                

```

